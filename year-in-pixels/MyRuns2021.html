<!DOCTYPE html>

<html>
  <head>
      <meta charset="utf-8">
      <title>My Runs 2021</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">

      <link rel="preconnect" href="https://fonts.gstatic.com">
      <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">

  <style type="text/css">
/* http://meyerweb.com/eric/tools/css/reset/ 
   v2.0 | 20110126
   License: none (public domain)
*/

html, body, div, span, applet, object, iframe,
h1, h2, h3, h4, h5, h6, p, blockquote, pre,
a, abbr, acronym, address, big, cite, code,
del, dfn, em, img, ins, kbd, q, s, samp,
small, strike, strong, sub, sup, tt, var,
b, u, i, center,
dl, dt, dd, ol, ul, li,
fieldset, form, label, legend,
table, caption, tbody, tfoot, thead, tr, th, td,
article, aside, canvas, details, embed, 
figure, figcaption, footer, header, hgroup, 
menu, nav, output, ruby, section, summary,
time, mark, audio, video {
	margin: 0;
	padding: 0;
	border: 0;
	font-size: 100%;
	font: inherit;
	vertical-align: baseline;
}
/* HTML5 display-role reset for older browsers */
article, aside, details, figcaption, figure, 
footer, header, hgroup, menu, nav, section {
	display: block;
}
body {
	line-height: 1;
}
ol, ul {
	list-style: none;
}
blockquote, q {
	quotes: none;
}
blockquote:before, blockquote:after,
q:before, q:after {
	content: '';
	content: none;
}
table {
	border-collapse: collapse;
	border-spacing: 0;
}


h1 {
  margin: 16px;
  font-size: 48px;
}


body {
  font-family: 'Roboto', sans-serif;
 
  text-align: center;
}

table {
    border-collapse: collapse;
    border-spacing: 0;
    text-align: center;
    margin: 0 auto;
}

table td {
  padding: 2px;
  color: white;
}

table th {
  color: #a5a5a5;
  padding: 2px;
}

table tbody th {
  padding-right: 8px;
}

table thead th {
  padding-bottom: 8px;
}

table th.month {
  text-align: left;
}

td.min .cell { background-color:#e81d61; }
td.below .cell { background-color: #00bad3; }
td.normal .cell { background-color: #278ef2; }
td.above .cell { background-color: #8ac249;}
td.max .cell { background-color: #374046; }

td.total { color: #a5a5a5; text-align: right; padding-left: 16px; }

.cell {
  height: 36px;
  width: 36px;
  line-height: 36px;
  font-size: 16px;
  border-radius: 50%;
}

  </style>
  </head>
  <body>

<script type="text/javascript">

const Endo2019 = `[
{"year":2019,"month":1,"day":3,"type":"Running","distance":6158.270835876465,"time":"00:36:09","calories":407},
{"year":2019,"month":1,"day":6,"type":"Running","distance":10043.747901916504,"time":"01:03:32","calories":674},
{"year":2019,"month":1,"day":14,"type":"Running","distance":8878.496170043945,"time":"00:55:11","calories":597},
{"year":2019,"month":1,"day":20,"type":"Running","distance":10741.8794631958,"time":"01:02:50","calories":712},
{"year":2019,"month":1,"day":28,"type":"Running","distance":10199.204444885254,"time":"01:07:04","calories":690},
{"year":2019,"month":2,"day":3,"type":"Running","distance":12126.740455627441,"time":"01:18:02","calories":818},
{"year":2019,"month":2,"day":4,"type":"Running","distance":9914.454460144043,"time":"01:02:24","calories":668},
{"year":2019,"month":2,"day":11,"type":"Running","distance":8464.049339294434,"time":"00:49:36","calories":561},
{"year":2019,"month":2,"day":15,"type":"Running","distance":206.07499778270721,"time":"00:03:21","calories":11},
{"year":2019,"month":2,"day":15,"type":"Running","distance":4377.281188964844,"time":"00:30:04","calories":297},
{"year":2019,"month":2,"day":24,"type":"Running","distance":11347.060203552246,"time":"01:17:40","calories":770},
{"year":2019,"month":2,"day":25,"type":"Running","distance":10821.147918701172,"time":"01:02:25","calories":714},
{"year":2019,"month":3,"day":2,"type":"Running","distance":18450.040817260742,"time":"01:51:12","calories":1232},
{"year":2019,"month":3,"day":4,"type":"Running","distance":12097.33772277832,"time":"01:07:12","calories":791},
{"year":2019,"month":3,"day":10,"type":"Running","distance":15095.746994018555,"time":"01:34:28","calories":1016},
{"year":2019,"month":3,"day":11,"type":"Running","distance":11981.133460998535,"time":"01:08:57","calories":790},
{"year":2019,"month":3,"day":13,"type":"Running","distance":9223.575592041016,"time":"00:53:56","calories":611},
{"year":2019,"month":3,"day":20,"type":"Running","distance":12339.105606079102,"time":"01:15:54","calories":828},
{"year":2019,"month":3,"day":24,"type":"Running","distance":8065.038681030273,"time":"00:49:06","calories":540},
{"year":2019,"month":3,"day":26,"type":"Running","distance":9562.936782836914,"time":"00:56:28","calories":635},
{"year":2019,"month":3,"day":27,"type":"Running","distance":8280.623435974121,"time":"00:46:31","calories":543},
{"year":2019,"month":3,"day":31,"type":"Running","distance":21097.5,"time":"01:57:26","calories":1380},
{"year":2019,"month":4,"day":8,"type":"Running","distance":6411.462783813477,"time":"00:36:57","calories":423},
{"year":2019,"month":4,"day":24,"type":"Running","distance":4487.706184387207,"time":"00:26:11","calories":297},
{"year":2019,"month":5,"day":2,"type":"Running","distance":5564.434051513672,"time":"00:35:37","calories":375},
{"year":2019,"month":5,"day":5,"type":"Running","distance":12279.086112976074,"time":"01:15:36","calories":824},
{"year":2019,"month":5,"day":14,"type":"Running","distance":11135.855674743652,"time":"01:09:21","calories":749},
{"year":2019,"month":5,"day":29,"type":"Running","distance":6381.821155548096,"time":"00:36:15","calories":420},
{"year":2019,"month":6,"day":8,"type":"Running","distance":5281.746864318848,"time":"00:33:15","calories":356},
{"year":2019,"month":6,"day":9,"type":"Running","distance":6290.939807891846,"time":"00:36:05","calories":415},
{"year":2019,"month":6,"day":13,"type":"Running","distance":6029.425144195557,"time":"00:35:17","calories":399},
{"year":2019,"month":6,"day":16,"type":"Running","distance":14012.001037597656,"time":"01:22:31","calories":930},
{"year":2019,"month":6,"day":20,"type":"Running","distance":8459.364891052246,"time":"00:45:29","calories":549},
{"year":2019,"month":7,"day":7,"type":"Running","distance":5459.9199295043945,"time":"00:33:14","calories":365},
{"year":2019,"month":7,"day":11,"type":"Running","distance":8178.447723388672,"time":"00:51:59","calories":551},
{"year":2019,"month":7,"day":14,"type":"Running","distance":11370.068550109863,"time":"01:11:55","calories":766},
{"year":2019,"month":7,"day":17,"type":"Running","distance":9269.20223236084,"time":"00:56:50","calories":621},
{"year":2019,"month":7,"day":18,"type":"Running","distance":3522.1729278564453,"time":"00:21:35","calories":236},
{"year":2019,"month":7,"day":22,"type":"Running","distance":9877.028465270996,"time":"01:00:02","calories":661},
{"year":2019,"month":7,"day":27,"type":"Running","distance":10095.428466796875,"time":"01:03:34","calories":680},
{"year":2019,"month":7,"day":28,"type":"Running","distance":11828.709602355957,"time":"01:10:52","calories":788},
{"year":2019,"month":8,"day":3,"type":"Running","distance":10000,"time":"00:50:03","calories":628},
{"year":2019,"month":8,"day":6,"type":"Running","distance":9446.138381958008,"time":"00:55:45","calories":627},
{"year":2019,"month":8,"day":11,"type":"Running","distance":10719.482421875,"time":"01:00:46","calories":704},
{"year":2019,"month":8,"day":15,"type":"Running","distance":10468.807220458984,"time":"00:59:16","calories":688},
{"year":2019,"month":8,"day":17,"type":"Running","distance":11479.339599609375,"time":"01:03:46","calories":751},
{"year":2019,"month":8,"day":20,"type":"Running","distance":11973.8130569458,"time":"01:06:59","calories":784},
{"year":2019,"month":8,"day":22,"type":"Running","distance":5004.591941833496,"time":"00:30:59","calories":336},
{"year":2019,"month":8,"day":25,"type":"Biking","distance":36364.99881744385,"time":"02:42:44","calories":929},
{"year":2019,"month":8,"day":31,"type":"Running","distance":9773.110389709473,"time":"00:56:53","calories":647},
{"year":2019,"month":8,"day":31,"type":"Running","distance":6532.9999923706055,"time":"00:42:59","calories":441},
{"year":2019,"month":9,"day":1,"type":"Biking","distance":6940,"time":"00:31:00","calories":177},
{"year":2019,"month":9,"day":1,"type":"Biking","distance":8400,"time":"00:37:00","calories":214},
{"year":2019,"month":9,"day":1,"type":"Biking","distance":14490,"time":"01:04:00","calories":370},
{"year":2019,"month":9,"day":1,"type":"Biking","distance":29830,"time":"02:12:00","calories":1093},
{"year":2019,"month":9,"day":3,"type":"Running","distance":10830.544471740723,"time":"00:59:30","calories":706},
{"year":2019,"month":9,"day":7,"type":"Running","distance":10000,"time":"00:49:02","calories":622},
{"year":2019,"month":9,"day":29,"type":"Running","distance":5391.067981719971,"time":"00:26:02","calories":333},
{"year":2019,"month":10,"day":15,"type":"Running","distance":5550.577163696289,"time":"00:37:37","calories":376},
{"year":2019,"month":10,"day":22,"type":"Running","distance":7850,"time":"00:47:57","calories":525},
{"year":2019,"month":10,"day":22,"type":"Running","distance":1609,"time":"00:06:48","calories":94},
{"year":2019,"month":11,"day":3,"type":"Running","distance":12436.062812805176,"time":"01:10:07","calories":816},
{"year":2019,"month":11,"day":6,"type":"Running","distance":5597.5751876831055,"time":"00:33:16","calories":372},
{"year":2019,"month":11,"day":17,"type":"Running","distance":6623.396873474121,"time":"00:35:05","calories":428},
{"year":2019,"month":11,"day":20,"type":"Running","distance":10597.036361694336,"time":"00:59:15","calories":694},
{"year":2019,"month":11,"day":27,"type":"Running","distance":4981.159210205078,"time":"00:32:44","calories":337},
{"year":2019,"month":11,"day":30,"type":"Running","distance":13296.540260314941,"time":"01:26:19","calories":898},
{"year":2019,"month":12,"day":1,"type":"Running","distance":8809.375762939453,"time":"00:53:32","calories":589},
{"year":2019,"month":12,"day":30,"type":"Running","distance":5648.51188659668,"time":"00:33:00","calories":374}
]`;

const myData = JSON.parse(Endo2019);


/*
const myData = [
  {
    year: 2021,
    month: 1,
    day: 1,
    type: "run",
    distance: 8.31,
    time: "00:53:00",
    steps: 9672
  },
  {
    year: 2021,
    month: 1,
    day: 2,
    type: "walk",
    distance: 4.23,
    time: "00:49:04",
    steps: 8601
  }
]*/

const ALL = 'ALL'
const RUN = 'Running'
const WALK = 'walk'

const TYPE = {}
TYPE[ALL] = ALL
TYPE[RUN] = RUN
TYPE[WALK] = WALK

const DISTANCE = 'distance'
const TIME = 'time'
const STEPS = 'steps'

const VALUE = {}
VALUE[DISTANCE] = DISTANCE
VALUE[TIME] = TIME
VALUE[STEPS] = STEPS

const UNIT = {}
UNIT[DISTANCE] = 'km'
UNIT[TIME] = ''
UNIT[STEPS] = 'steps'


function timeStringToFloat(time) {
  var hoursMinutes = time.split(/[.:]/)
  var hours = parseInt(hoursMinutes[0], 10)
  var minutes = hoursMinutes[1] ? parseInt(hoursMinutes[1], 10) : 0
  var seconds = hoursMinutes[2] ? parseInt(hoursMinutes[2], 10) : 0
  return hours + minutes / 60 + seconds / 3600
}

const TO_NUMBER = {}
TO_NUMBER[DISTANCE] = (v) => v / 1000
TO_NUMBER[TIME] = timeStringToFloat
TO_NUMBER[STEPS] = (v) => v

const TO_STRING = {}
TO_STRING[DISTANCE] = (v) => Math.round(v)
TO_STRING[TIME] = (v) => Math.round(v)
TO_STRING[STEPS] = (v) => Math.round(v / 1000) + 'k'


const numberOfMonths = 12
const numberOfDays = 31

function prepareData(arr, year, type = ALL, metric = DISTANCE) {
  let farr = arr.filter((v) => { return v.year === year } )

  if (type !== ALL) {
    farr = farr.filter((v) => { return v.type === type } )
  }

  let data = []

  for (let i in farr) {
    if (farr[i][metric]) {
      let m = farr[i].month
      let d = farr[i].day

      if(!data[m]) {
        data[m] = []
      }

      if(!data[m][d]) {
        data[m][d] = 0
      }
      
      data[m][d] += TO_NUMBER[metric](farr[i][metric])
    }
  }


  return data;
}

function daysInMonth (month, year) {
    return new Date(year, month, 0).getDate();
}


const year = 2019
const type = RUN
const value = DISTANCE
const data = prepareData(myData, year, type, value)

//adapted from https://blog.poettner.de/2011/06/09/simple-statistics-with-php/
function Median(data) {
  return Quartile_50(data);
}

function Quartile_25(data) {
  return Quartile(data, 0.25);
}

function Quartile_50(data) {
  return Quartile(data, 0.5);
}

function Quartile_75(data) {
  return Quartile(data, 0.75);
}

function Quartile(data, q) {
  data=Array_Sort_Numbers(data);
  var pos = ((data.length) - 1) * q;
  var base = Math.floor(pos);
  var rest = pos - base;
  if( (data[base+1]!==undefined) ) {
    return data[base] + rest * (data[base+1] - data[base]);
  } else {
    return data[base];
  }
}

function Array_Sort_Numbers(inputarray){
  return inputarray.sort(function(a, b) {
    return a - b;
  });
}

function Array_Sum(t){
   return t.reduce(function(a, b) { return a + b; }, 0); 
}

function Array_Average(data) {
  return Array_Sum(data) / data.length;
}

function Array_Stdev(tab){
   var i,j,total = 0, mean = 0, diffSqredArr = [];
   for(i=0;i<tab.length;i+=1){
       total+=tab[i];
   }
   mean = total/tab.length;
   for(j=0;j<tab.length;j+=1){
       diffSqredArr.push(Math.pow((tab[j]-mean),2));
   }
   return (Math.sqrt(diffSqredArr.reduce(function(firstEl, nextEl){
            return firstEl + nextEl;
          })/tab.length));  
}

function getStates(data) {
  let nums = data.flat()

  let min = 0
  let q25 = Quartile_25(nums)
  let q50 = Quartile_50(nums)
  let q75 = Quartile_75(nums)
  let max = Math.max.apply(Math, nums)

  let pt1 = min
  let pt2 = q25 + (q50 - q25) / 2
  let pt3 = q50 + (q75 - q50) / 2
  let pt4 = max

  let states = [
    [pt1, pt1, "MIN"],
    [pt1, pt2, "BELOW"],
    [pt2, pt3, "NORMAL"],
    [pt3, Math.floor(pt4), "ABOVE"],
    [Math.floor(pt4), pt4, "MAX"]
  ]

  return states
}

let states = getStates(data)

function numberToState(num, states, func = Math.round) {
  if (num === null) {
    return "EMPTY"
  }

  for (var i in states) {
    let n = func(num)
    let min = func(states[i][0])
    let max = func(states[i][1])

    if (n >= min && n <= max) {
      return states[i][2]
    }
  }

  return 'UNKNOWN'
}



const monthsPL = ['S', 'L', 'M', 'K', 'M', 'C', 'L', 'S', 'W', 'P', 'L', 'G']
const monthsPL_SHORT = ['STY', 'LUT', 'MAR', 'KWI', 'MAJ', 'CZE', 'LIP', 'SIE', 'WRZ', 'PAŹ', 'LIS', 'GRU']
const monthsEN = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D']

const months = monthsPL_SHORT

const colors = [];

let uom = UNIT[value]

let rows = '';

for (let m = 1; m <= numberOfMonths; m++) {
  rows += `<tr>
      <th class="month" scope="row">${months[m-1]}</th>`;

  for (let d = 1; d <= numberOfDays; d++) {
    let metric = data[m] ? (data[m][d] ? data[m][d] : null ) : null
    let state = numberToState(metric, states)
    metric = state !== "EMPTY" && state !== "UNKNOWN" ? TO_STRING[value](metric) : 0

    rows += `<td class="${state.toLowerCase()}"><div class="cell">${metric}</div></td>`;
  }

  let total = data[m] ? Math.round(data[m].reduce((a, b) => a + b)) : 0
  let totalValue = TO_STRING[value](total)

  rows += `<td class="total">${totalValue} ${uom}</td>`;

  rows += `</tr>`;
}

let table = `<table>
  <thead>
      <tr>
          <th></th>`

for (let d = 1; d <= numberOfDays; d++) {
  table += `<th scope="col">${d}</th>`
}

table += `<th scope="col">Total</th>`

table += `</tr>
  </thead>
  <tbody>
    ${rows}
  </tbody>
  </tabel>`;


let content = `<h1>${year}</h1>${table}`;

document.getElementsByTagName('body')[0].innerHTML += content;


</script>
  </body>
</html>